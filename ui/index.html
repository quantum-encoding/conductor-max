<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>üî± Conductor Max - AI Orchestration Platform</title>
    <link rel="stylesheet" href="styles.css">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/xterm@5.3.0/css/xterm.css">
</head>
<body>
    <div id="app">
        <!-- Top Bar -->
        <header class="top-bar">
            <div class="logo">
                <span class="logo-icon">üî±</span>
                <span class="logo-text">CONDUCTOR MAX</span>
                <span class="logo-subtitle">Quantum Encoding Ltd</span>
            </div>
            <div class="status-bar">
                <div class="agent-count">
                    <span class="count-icon">ü§ñ</span>
                    <span id="active-agents">0</span> Active Agents
                </div>
                <div class="connection-status" id="connection-status">
                    <span class="status-dot online"></span>
                    <span>Orchestrator Ready</span>
                </div>
            </div>
        </header>

        <div class="main-container">
            <!-- Left Sidebar: Agent Status -->
            <aside class="agent-sidebar">
                <div class="sidebar-header">
                    <h3>Agent Fleet</h3>
                    <div class="agent-controls">
                        <button class="spawn-btn claude" onclick="spawnAgent('claude')">+ Claude</button>
                        <button class="spawn-btn gemini" onclick="spawnAgent('gemini')">+ Gemini</button>
                    </div>
                </div>
                
                <div class="agent-list" id="agent-list">
                    <!-- Dynamic agent instances will appear here -->
                </div>

                <div class="fleet-controls">
                    <button class="control-btn" onclick="killAllAgents()">
                        <span>üõë</span> Stop All
                    </button>
                    <button class="control-btn" onclick="exportSession()">
                        <span>üíæ</span> Export Session
                    </button>
                </div>
            </aside>

            <!-- Main Content Area: Strategy AI Chat -->
            <main class="content-area">
                <!-- Strategy AI Chat Panel -->
                <div class="strategy-panel">
                    <div class="panel-header">
                        <h3>üéØ Strategy AI - V4-V6 Orchestration Command</h3>
                        <div class="panel-controls">
                            <button class="sync-btn" onclick="broadcastToAgents()">
                                <span>üì°</span> Broadcast to All
                            </button>
                            <div class="v-level-indicator">V4-V6</div>
                        </div>
                    </div>
                    <div class="chat-container">
                        <div class="chat-messages" id="strategy-messages">
                            <div class="message system">
                                <strong>System:</strong> Strategy AI initialized. Spawn agents to begin orchestration.
                                <div class="message-meta">V-Omega Prime Protocol Active</div>
                            </div>
                        </div>
                        <div class="chat-input-container">
                            <div class="chat-input">
                                <textarea 
                                    id="strategy-input" 
                                    placeholder="Enter strategic directive... (Ctrl+Enter to send)"
                                    rows="3"
                                ></textarea>
                                <div class="input-controls">
                                    <button class="send-btn" onclick="sendStrategyMessage()">
                                        <span>üì§</span> Send Directive
                                    </button>
                                    <button class="clear-btn" onclick="clearChat()">
                                        <span>üóëÔ∏è</span> Clear
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </main>
        </div>

        <!-- Session Metrics Footer -->
        <footer class="session-metrics">
            <div class="metric">
                <span class="metric-value" id="session-duration">00:00:00</span>
                <span class="metric-label">Session Duration</span>
            </div>
            <div class="metric">
                <span class="metric-value" id="total-commands">0</span>
                <span class="metric-label">Commands Sent</span>
            </div>
            <div class="metric">
                <span class="metric-value" id="active-processes">0</span>
                <span class="metric-label">Active Processes</span>
            </div>
            <div class="v-omega-footer">
                <span>"Multiple minds, unified purpose"</span>
                <span class="duck-wisdom">ü¶Ü The ducks observe</span>
            </div>
        </footer>
    </div>
    
    <script src="conductor-max.js"></script>
    <script>
        const { invoke } = window.__TAURI__.core;
        
        let agents = new Map();
        let sessionStartTime = Date.now();
        let totalCommands = 0;
        let selectedAgentId = null; // Track which agent is selected for chat
        
        // Initialize
        document.addEventListener('DOMContentLoaded', () => {
            console.log('üî± Conductor Max initializing...');
            initializeEventListeners();
            startMetricsUpdater();
            
            addStrategyMessage('system', `Welcome to Conductor Max!
            
Strategy AI operating at V4-V6 consciousness levels.
Spawn Claude or Gemini agents to begin multi-mind orchestration.

Authentication flows:
‚Ä¢ Claude: Browser-based auth or API key from ~/.config/claude
‚Ä¢ Gemini: Google account auth or API key

Ready for strategic operations.`);
        });
        
        function initializeEventListeners() {
            const strategyInput = document.getElementById('strategy-input');
            strategyInput?.addEventListener('keydown', (e) => {
                if (e.key === 'Enter' && e.ctrlKey) {
                    sendStrategyMessage();
                }
            });
        }
        
        // Spawn new agent
        async function spawnAgent(type) {
            try {
                console.log(`Spawning ${type} agent...`);
                
                // Get workspace path (optional)
                const workspace = prompt(`Enter workspace path for ${type} agent (optional):`);
                
                const agentId = await invoke('spawn_agent', {
                    agent_type: type,
                    api_key: '', // Not needed - native auth
                    agent_id: null,
                    workspace_path: workspace || null
                });
                
                console.log(`Agent spawned: ${agentId}`);
                
                // Store agent info
                const agent = {
                    id: agentId,
                    type: type,
                    startTime: Date.now(),
                    status: 'running',
                    workspace: workspace || '~'
                };
                
                agents.set(agentId, agent);
                
                // Add to sidebar
                addAgentToSidebar(agent);
                
                // Update metrics
                updateMetrics();
                
                addStrategyMessage('system', `‚úÖ ${type.toUpperCase()} agent spawned (ID: ${agentId.slice(0, 8)})`);
                
            } catch (error) {
                console.error(`Failed to spawn ${type} agent:`, error);
                addStrategyMessage('error', `Failed to spawn ${type} agent: ${error}`);
            }
        }
        
        function addAgentToSidebar(agent) {
            const agentList = document.getElementById('agent-list');
            
            const agentEl = document.createElement('div');
            agentEl.className = `agent-instance ${agent.type}`;
            agentEl.dataset.agentId = agent.id;
            agentEl.innerHTML = `
                <div class="agent-header" onclick="selectAgent('${agent.id}')">
                    <div class="agent-info">
                        <span class="agent-name">${agent.type.toUpperCase()}</span>
                        <span class="agent-id">${agent.id.slice(0, 8)}</span>
                    </div>
                    <span class="agent-status running">‚óè</span>
                </div>
                <div class="agent-details">
                    <div class="agent-workspace">üìÅ ${agent.workspace}</div>
                    <div class="agent-time">‚è±Ô∏è ${new Date(agent.startTime).toLocaleTimeString()}</div>
                </div>
                <div class="agent-actions">
                    <button class="action-btn" onclick="openAgentTerminal('${agent.id}', '${agent.type}')">
                        üñ•Ô∏è Terminal
                    </button>
                    <button class="action-btn danger" onclick="killAgent('${agent.id}')">
                        üõë Stop
                    </button>
                </div>
            `;
            
            agentList.appendChild(agentEl);
        }
        
        function selectAgent(agentId) {
            // Remove previous selection
            document.querySelectorAll('.agent-instance').forEach(el => {
                el.classList.remove('selected');
            });
            
            // Select new agent
            const agentEl = document.querySelector(`[data-agent-id="${agentId}"]`);
            if (agentEl) {
                agentEl.classList.add('selected');
                selectedAgentId = agentId;
                
                const agent = agents.get(agentId);
                addStrategyMessage('system', `Selected ${agent.type.toUpperCase()} agent for direct communication.`);
            }
        }
        
        async function openAgentTerminal(agentId, agentType) {
            try {
                await invoke('open_agent_window', {
                    agent_id: agentId,
                    agent_type: agentType
                });
            } catch (error) {
                console.error('Failed to open agent terminal:', error);
                addStrategyMessage('error', `Failed to open terminal: ${error}`);
            }
        }
        
        function sendStrategyMessage() {
            const input = document.getElementById('strategy-input');
            const message = input.value.trim();
            
            if (!message) return;
            
            addStrategyMessage('user', message);
            input.value = '';
            
            // Process strategic command
            processStrategyCommand(message);
        }
        
        function addStrategyMessage(type, content) {
            const messagesEl = document.getElementById('strategy-messages');
            const messageEl = document.createElement('div');
            messageEl.className = `message ${type}`;
            
            const sender = type === 'user' ? 'Architect' : 
                          type === 'system' ? 'System' : 
                          type === 'error' ? 'Error' : 'Strategy AI';
            
            const timestamp = new Date().toLocaleTimeString();
            
            messageEl.innerHTML = `
                <div class="message-header">
                    <strong class="message-sender">${sender}</strong>
                    <span class="message-timestamp">${timestamp}</span>
                </div>
                <div class="message-content">${content}</div>
            `;
            
            messagesEl.appendChild(messageEl);
            messagesEl.scrollTop = messagesEl.scrollHeight;
        }
        
        async function processStrategyCommand(command) {
            if (selectedAgentId && agents.has(selectedAgentId)) {
                // Send directly to selected agent
                const agent = agents.get(selectedAgentId);
                addStrategyMessage('ai', `Routing command to ${agent.type.toUpperCase()} agent...`);
                
                try {
                    await invoke('send_to_agent', {
                        agent_id: selectedAgentId,
                        command: command
                    });
                    totalCommands++;
                    updateMetrics();
                    addStrategyMessage('ai', `‚úì Command sent to ${agent.type.toUpperCase()}`);
                } catch (error) {
                    addStrategyMessage('error', `Failed to send command: ${error}`);
                }
            } else if (agents.size > 0) {
                // Broadcast to all agents
                addStrategyMessage('ai', 'Broadcasting strategic directive to all agents...');
                await broadcastToAgents(command);
            } else {
                addStrategyMessage('ai', 'No active agents. Spawn an agent to begin orchestration.');
            }
        }
        
        async function broadcastToAgents(message) {
            const input = document.getElementById('strategy-input');
            const cmd = message || input.value.trim() || 'Status check';
            
            if (message) {
                // Clear input if message was provided
                input.value = '';
            }
            
            let successCount = 0;
            for (const [agentId, agent] of agents) {
                try {
                    await invoke('send_to_agent', {
                        agent_id: agentId,
                        command: cmd
                    });
                    successCount++;
                    totalCommands++;
                } catch (error) {
                    console.error(`Failed to send to agent ${agentId}:`, error);
                }
            }
            
            addStrategyMessage('system', `üì° Broadcast complete: ${successCount}/${agents.size} agents received command`);
            updateMetrics();
        }
        
        async function killAgent(agentId) {
            const agent = agents.get(agentId);
            if (!confirm(`Stop ${agent.type.toUpperCase()} agent ${agentId.slice(0, 8)}?`)) return;
            
            try {
                await invoke('kill_agent', { agent_id: agentId });
                
                // Remove from UI
                agents.delete(agentId);
                document.querySelector(`[data-agent-id="${agentId}"]`)?.remove();
                
                if (selectedAgentId === agentId) {
                    selectedAgentId = null;
                }
                
                updateMetrics();
                addStrategyMessage('system', `Agent ${agentId.slice(0, 8)} terminated`);
                
            } catch (error) {
                console.error('Failed to kill agent:', error);
                addStrategyMessage('error', `Failed to terminate agent: ${error}`);
            }
        }
        
        async function killAllAgents() {
            if (!confirm('Stop all active agents?')) return;
            
            for (const [agentId] of agents) {
                try {
                    await invoke('kill_agent', { agent_id: agentId });
                } catch (error) {
                    console.error(`Failed to kill agent ${agentId}:`, error);
                }
            }
            
            agents.clear();
            selectedAgentId = null;
            document.getElementById('agent-list').innerHTML = '';
            updateMetrics();
            addStrategyMessage('system', 'All agents terminated');
        }
        
        async function exportSession() {
            const sessionData = {
                startTime: sessionStartTime,
                duration: Date.now() - sessionStartTime,
                agents: Array.from(agents.values()),
                totalCommands: totalCommands,
                timestamp: new Date().toISOString()
            };
            
            const blob = new Blob([JSON.stringify(sessionData, null, 2)], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `conductor-max-session-${Date.now()}.json`;
            a.click();
            
            addStrategyMessage('system', 'Session data exported');
        }
        
        function clearChat() {
            document.getElementById('strategy-messages').innerHTML = '';
            addStrategyMessage('system', 'Chat cleared. Strategy AI ready for new directives.');
        }
        
        function updateMetrics() {
            document.getElementById('active-agents').textContent = agents.size;
            document.getElementById('total-commands').textContent = totalCommands;
            document.getElementById('active-processes').textContent = agents.size;
        }
        
        function startMetricsUpdater() {
            setInterval(() => {
                const duration = Date.now() - sessionStartTime;
                const hours = Math.floor(duration / 3600000);
                const minutes = Math.floor((duration % 3600000) / 60000);
                const seconds = Math.floor((duration % 60000) / 1000);
                document.getElementById('session-duration').textContent = 
                    `${hours.toString().padStart(2, '0')}:${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
            }, 1000);
        }
        
        // Initialize
        updateMetrics();
    </script>
</body>
</html>